# 计算机体系结构基础

现代计算机都是基于 Von Neumann 体系结构。这种体系结构的主要特点是：
- CPU 和 内存 是两个主要组成部分
- 内存中保存数据和指令
- CPU 从内存中取指令执行

## 内存与地址

内存地址 从 0 开始编址。

内存单元 只能存储 1 个字节的内容。

## CPU

CPU 总是在周而复始地做同一件事：从内存取指令，然后执行它，然后再取下一条指令，再解释执行。

CPU 最核心的功能单元包括：
- 寄存器（Register），是 CPU 内部的高速存储器。
- 程序计数器（Program Counter），是一类特殊的寄存器，保存着 CPU 取下一条指令的地址。
- 指令译码器（Instruction Decoder），负责解释指令的含义，然后调用相应的执行单元去执行它。
- 算术逻辑单元（ALU，Arithmetic and Logic Unit），负责执行运算指令。
- 地址和数据总线（Bus），CPU 和 内存 之间用 地址总线、数据总线 和 控制线 连接起来。

## 设备

从 CPU 的角度来看，访问设备只有 内存映射I/O 和 端口I/O 两种。CPU 通过内存映射I/O或端口I/O访问相应的总线控制器，通过总线控制器再去访问挂在总线上的设备。

操作系统最核心的功能是管理进程调度、管理内存的分配使用和管理各种设备，做这些工作的程序称为内核（Kernel）。

设备不同于内存，内存往往是被动地等待 CPU 来读写。设备往往会主动产生数据，主动通知 CPU 来读它产生的数据。在这种情况下，可以采用 中断机制（Interrupt）实现。

中断机制：
- 每个设备都有一条中断线，通过中断控制器连接到 CPU
- 当设备需要主动通知 CPU 时，就引发一个中断信号，CPU 正在执行的指令将被打断。程序计数器会指向某个固定的地址（这个地址由体系结构指定），于是 CPU 从这个地址开始取指令（或者说跳转到这个地址），执行中断服务程序（ISR，Interrupt Service Routine）。当完成中断处理后再返回之前被打断的地方继续执行指令。

## MMU

内存管理单元（MMU，Memory Management Unit）是 CPU 内的一个组成部分。

现代操作系统普遍采用 虚拟内存管理机制（Virtual Memory Management），这需要处理器中的 MMU 提供支持。

虚拟地址 和 物理地址：
- 物理地址（Physical Address）：如果 CPU 不启用 MMU，则从 CPU 发出的内存地址称为物理地址。
- 虚拟地址（Virtual Address）：如果 CPU 启动了 MMU，则从 CPU 发出的内存地址将被 MMU 截获。在 CPU 和 MMU 之间的地址称为虚拟地址。

MMU 将 VA 映射到 PA 是以 页（Page）为单位的，32位处理器的页尺寸通常是 4KB。

物理内存中的页称为物理页面或页帧（Page Frame）。

虚拟内存的页面映射到物理内存的哪个页面说通过 页表（Page Table）来描述，页表存储在物理内存上，MMU 通过访问页表来确定从 VA 到 PA 的映射。

操作系统和 MMU 的配合：
1. 操作系统在初始化或分配、释放内存时会执行一些指令在物理内存中填写页表，然后用指令设置 MMU，告诉 MMU 页表在物理内存中的什么位置。
2. 设置好之后，CPU 每次执行访问内存的指令都会自动引发 MMU 做查表和地址转换操作，地址转换操作由硬件自动完成，不需要用指令控制 MMU 去做。

MMU 除了做地址转换工作外，还提供内存保护机制。

用户模式（User Mode）和 特权模式（Privileged Mode）

中断和异常：
- 中断（Interrupt），由硬件产生
- 异常（Exception），由 CPU 内部产生

通常操作系统把虚拟空间划分为用户空间和内核空间，例如 x86 平台的 Linux 系统虚拟地址空间是 0x00000000~0xffffffff，前3GB（0x00000000~0xbfffffff）是用户空间，后1GB（0xc0000000~0xffffffff）是内核空间。

在正常情况下处理器在用户模式下执行用户程序，在中断或异常情况下处理器切换到特权模式执行内核程序，处理完中断或异常之后再返回用户模式继续执行用户程序。

段错误的产生：
1. 用户程序要访问的一个 VA，经 MMU 检查无权访问。
2. MMU 产生一个异常，CPU 从用户模式切换到特权模式，跳转到内核代码中执行异常服务程序。
3. 内核把这个异常解释为段错误，把引发异常的进程中止掉。

## Memory Hierarchy

越接近 CPU 的存储器速度越快但容量越小。

1. CPU 寄存器

2. 1级 Cache

3. 2级 Cache

4. 内存

5. 硬盘
